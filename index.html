<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Toilet Coordination System</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: Arial, sans-serif;
            background-color: #f5f5f5;
            padding: 20px;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background-color: #2c3e50;
            color: white;
            padding: 20px;
            text-align: center;
        }

        .setup-section {
            padding: 30px;
        }

        .teacher-section {
            padding: 30px;
            display: none;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 10px;
            font-weight: bold;
            font-size: 16px;
        }

        select {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
            background-color: white;
        }

        .classes-selection {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .class-checkbox {
            display: flex;
            align-items: center;
            padding: 15px;
            border: 2px solid #ddd;
            border-radius: 8px;
            background-color: #f8f9fa;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .class-checkbox:hover {
            background-color: #e9ecef;
        }

        .class-checkbox.selected {
            background-color: #d4edda;
            border-color: #27ae60;
        }

        .class-checkbox input[type="checkbox"] {
            margin-right: 10px;
            transform: scale(1.2);
        }

        .class-checkbox label {
            margin: 0;
            font-weight: normal;
            cursor: pointer;
            flex: 1;
        }

        button {
            background-color: #3498db;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin: 5px;
        }

        button:hover {
            background-color: #2980b9;
        }

        .create-btn {
            background-color: #27ae60;
            padding: 15px 30px;
            font-size: 18px;
            font-weight: bold;
        }

        .create-btn:hover {
            background-color: #219a52;
        }

        .create-btn:disabled {
            background-color: #95a5a6;
            cursor: not-allowed;
        }

        .class-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .class-card {
            border: 2px solid #ddd;
            border-radius: 10px;
            padding: 20px;
            text-align: center;
            transition: all 0.3s ease;
        }

        .class-card.vacant {
            background-color: #d4edda;
            border-color: #27ae60;
        }

        .class-card.occupied {
            background-color: #f8d7da;
            border-color: #e74c3c;
        }

        .class-name {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 15px;
        }

        .status-display {
            font-size: 16px;
            margin-bottom: 15px;
            padding: 8px;
            border-radius: 5px;
            font-weight: bold;
        }

        .vacant .status-display {
            background-color: #27ae60;
            color: white;
        }

        .occupied .status-display {
            background-color: #e74c3c;
            color: white;
        }

        .toggle-btn {
            width: 100%;
            padding: 15px;
            font-size: 16px;
            font-weight: bold;
            border-radius: 8px;
            transition: all 0.3s ease;
        }

        .toggle-btn.vacant {
            background-color: #27ae60;
            color: white;
        }

        .toggle-btn.occupied {
            background-color: #e74c3c;
            color: white;
        }

        .toggle-btn:hover {
            transform: scale(1.05);
        }

        .warning {
            background-color: #fff3cd;
            border: 1px solid #ffeaa7;
            color: #856404;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 10px;
            font-weight: bold;
        }

        .access-links {
            margin-top: 20px;
            padding: 20px;
            background-color: #f8f9fa;
            border-radius: 8px;
        }

        .access-item {
            display: flex;
            align-items: center;
            margin: 15px 0;
            padding: 20px;
            background-color: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .qr-container {
            margin-right: 20px;
            text-align: center;
        }

        .qr-code {
            border: 2px solid #ddd;
            border-radius: 5px;
            padding: 5px;
            background-color: white;
        }

        .qr-label {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
        }

        .link-info {
            flex: 1;
        }

        .class-title {
            font-size: 18px;
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 8px;
        }

        .access-link {
            display: inline-block;
            padding: 8px 15px;
            background-color: #3498db;
            color: white;
            text-decoration: none;
            border-radius: 5px;
            font-size: 14px;
            margin-bottom: 8px;
        }

        .access-link:hover {
            background-color: #2980b9;
        }

        .url-display {
            font-family: monospace;
            font-size: 12px;
            color: #666;
            background-color: #f8f9fa;
            padding: 5px 8px;
            border-radius: 3px;
            word-break: break-all;
        }

        .print-section {
            margin-top: 20px;
            text-align: center;
        }

        .print-btn {
            background-color: #17a2b8;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
        }

        .print-btn:hover {
            background-color: #138496;
        }

        @media print {
            .print-btn, .back-btn, .create-btn {
                display: none;
            }
            
            .access-item {
                page-break-inside: avoid;
                margin-bottom: 30px;
            }
        }

        .back-btn {
            background-color: #6c757d;
            margin-bottom: 20px;
        }

        .back-btn:hover {
            background-color: #545b62;
        }

        .emergency-warning {
            background-color: #dc3545;
            color: white;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 10px;
            font-weight: bold;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.7; }
            100% { opacity: 1; }
        }

        .selection-summary {
            margin-top: 20px;
            padding: 15px;
            background-color: #e7f3ff;
            border-radius: 8px;
            border-left: 4px solid #3498db;
        }

        .no-selection {
            color: #6c757d;
        }

        .sync-status {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 10px 15px;
            background-color: #28a745;
            color: white;
            border-radius: 5px;
            font-size: 14px;
            display: none;
            z-index: 1000;
        }

        .sync-status.syncing {
            background-color: #ffc107;
            color: #000;
        }

        .sync-status.error {
            background-color: #dc3545;
            color: white;
        }
    </style>
</head>
<body>
    <div class="sync-status" id="sync-status">Synced</div>
    
    <div class="container">
        <div class="header">
            <h1>Toilet Coordination System</h1>
            <p>Exam Logistics Management</p>
        </div>

        <!-- Setup Section -->
        <div id="setup-section" class="setup-section">
            <h2>Setup Classes for Exam</h2>
            
            <div class="form-group">
                <label for="level-select">Select Primary Level:</label>
                <select id="level-select" onchange="updateClassNames()">
                    <option value="">-- Select Level --</option>
                    <option value="1">Primary 1</option>
                    <option value="2">Primary 2</option>
                    <option value="3">Primary 3</option>
                    <option value="4">Primary 4</option>
                    <option value="5">Primary 5</option>
                    <option value="6">Primary 6</option>
                </select>
            </div>

            <div class="form-group">
                <label>Select Classes Participating in Exam:</label>
                <div class="classes-selection" id="classes-selection">
                    <!-- Classes will be populated here -->
                </div>
            </div>

            <div id="selection-summary" class="selection-summary">
                <strong>Selected Classes:</strong>
                <div id="summary-text" class="no-selection">Please select a level first</div>
            </div>

            <button id="create-btn" class="create-btn" onclick="setupClasses()" disabled>Create System</button>

            <div id="access-links" class="access-links" style="display: none;">
                <h3>Access Links for Teachers</h3>
                <p>Each teacher can scan their QR code or use the link below:</p>
                <div id="links-container"></div>
                <div class="print-section">
                    <button class="print-btn" onclick="window.print()">🖨️ Print QR Codes</button>
                </div>
            </div>
        </div>

        <!-- Teacher Interface -->
        <div id="teacher-section" class="teacher-section">
            <button class="back-btn" onclick="backToSetup()">Back to Setup</button>
            
            <h2 id="teacher-title">Teacher Dashboard</h2>
            <p id="teacher-class">Managing: <span id="current-class"></span></p>

            <div id="classes-grid" class="class-grid">
                <!-- Classes will be populated here -->
            </div>
        </div>
    </div>

    <script>
        // Global state
        let classes = {};
        let currentClass = null;
        let isTeacher = false;
        let selectedLevel = '';
        let selectedClasses = [];
        let setupId = null;

        const classNames = ['Care', 'Charity', 'Faith', 'Grace', 'Hope', 'Joy', 'Love', 'Respect'];

        // Generate a unique setup ID
        function generateSetupId() {
            return Date.now().toString(36) + Math.random().toString(36).substr(2);
        }

        // Encode state to base64
        function encodeState(state) {
            return btoa(JSON.stringify(state));
        }

        // Decode state from base64
        function decodeState(encoded) {
            try {
                return JSON.parse(atob(encoded));
            } catch (e) {
                console.error('Failed to decode state:', e);
                return null;
            }
        }

        // Initialize the application
        function init() {
            const urlParams = new URLSearchParams(window.location.search);
            const classParam = urlParams.get('class');
            const stateParam = urlParams.get('state');
            const setupParam = urlParams.get('setup');
            
            if (classParam && stateParam) {
                // Teacher view with state
                isTeacher = true;
                currentClass = decodeURIComponent(classParam);
                setupId = urlParams.get('setup');
                loadTeacherViewFromURL(stateParam);
            } else if (setupParam) {
                // Load existing setup
                setupId = setupParam;
                pollForState();
                showSetupSection();
            } else {
                // Fresh setup view
                showSetupSection();
                populateClassesSelection();
            }
        }

        function showSetupSection() {
            document.getElementById('setup-section').style.display = 'block';
            document.getElementById('teacher-section').style.display = 'none';
        }

        function showTeacherSection() {
            document.getElementById('setup-section').style.display = 'none';
            document.getElementById('teacher-section').style.display = 'block';
        }

        function populateClassesSelection() {
            const container = document.getElementById('classes-selection');
            container.innerHTML = '';

            classNames.forEach(className => {
                const div = document.createElement('div');
                div.className = 'class-checkbox';
                div.onclick = () => toggleClassSelection(className);
                
                div.innerHTML = `
                    <input type="checkbox" id="class-${className}" onchange="toggleClassSelection('${className}')">
                    <label for="class-${className}">${className}</label>
                `;
                
                container.appendChild(div);
            });
        }

        function updateClassNames() {
            const levelSelect = document.getElementById('level-select');
            selectedLevel = levelSelect.value;
            
            // Reset selections when level changes
            selectedClasses = [];
            const checkboxes = document.querySelectorAll('.class-checkbox input[type="checkbox"]');
            checkboxes.forEach(cb => {
                cb.checked = false;
                cb.parentElement.classList.remove('selected');
            });
            
            updateSelectionSummary();
            updateCreateButton();
        }

        function toggleClassSelection(className) {
            const checkbox = document.getElementById(`class-${className}`);
            const div = checkbox.parentElement;
            
            if (checkbox.checked) {
                if (!selectedClasses.includes(className)) {
                    selectedClasses.push(className);
                }
                div.classList.add('selected');
            } else {
                selectedClasses = selectedClasses.filter(name => name !== className);
                div.classList.remove('selected');
            }
            
            updateSelectionSummary();
            updateCreateButton();
        }

        function updateSelectionSummary() {
            const summaryText = document.getElementById('summary-text');
            
            if (!selectedLevel) {
                summaryText.textContent = 'Please select a level first';
                summaryText.className = 'no-selection';
                return;
            }
            
            if (selectedClasses.length === 0) {
                summaryText.textContent = 'No classes selected';
                summaryText.className = 'no-selection';
                return;
            }
            
            const formattedClasses = selectedClasses.map(name => `${selectedLevel} ${name}`).join(', ');
            summaryText.textContent = formattedClasses;
            summaryText.className = '';
        }

        function updateCreateButton() {
            const createBtn = document.getElementById('create-btn');
            const canCreate = selectedLevel && selectedClasses.length >= 2;
            
            createBtn.disabled = !canCreate;
            
            if (canCreate) {
                createBtn.textContent = `Create System (${selectedClasses.length} classes)`;
            } else {
                createBtn.textContent = 'Create System';
            }
        }

        function setupClasses() {
            if (!selectedLevel || selectedClasses.length < 2) {
                alert('Please select a level and at least 2 classes.');
                return;
            }

            // Generate unique setup ID
            setupId = generateSetupId();

            // Initialize classes state with formatted names
            classes = {};
            selectedClasses.forEach(className => {
                const formattedName = `${selectedLevel} ${className}`;
                classes[formattedName] = 'vacant';
            });

            // Save state for this setup
            saveState();

            // Generate access links
            generateAccessLinks();
        }

        function saveState() {
            if (setupId) {
                localStorage.setItem(`toiletSystem_${setupId}`, JSON.stringify({
                    classes: classes,
                    level: selectedLevel,
                    timestamp: Date.now()
                }));
            }
        }

        function loadState() {
            if (setupId) {
                const saved = localStorage.getItem(`toiletSystem_${setupId}`);
                if (saved) {
                    const data = JSON.parse(saved);
                    classes = data.classes;
                    selectedLevel = data.level;
                    return true;
                }
            }
            return false;
        }

        function generateQRCode(text, size = 128) {
            const qrUrl = `https://api.qrserver.com/v1/create-qr-code/?size=${size}x${size}&data=${encodeURIComponent(text)}&ecc=M`;
            return qrUrl;
        }

        function generateAccessLinks() {
            const linksContainer = document.getElementById('links-container');
            const accessLinksDiv = document.getElementById('access-links');
            
            linksContainer.innerHTML = '';
            
            // Add master control link first
            const masterUrl = `${window.location.origin}${window.location.pathname}?setup=${setupId}`;
            const masterItem = document.createElement('div');
            masterItem.className = 'access-item';
            masterItem.style.backgroundColor = '#e8f5e9';
            
            masterItem.innerHTML = `
                <div class="qr-container">
                    <img src="${generateQRCode(masterUrl, 150)}" alt="QR Code for Master Control" class="qr-code" width="120" height="120">
                    <div class="qr-label">Master Control</div>
                </div>
                <div class="link-info">
                    <div class="class-title">🎛️ Master Control Panel</div>
                    <a href="${masterUrl}" class="access-link" target="_blank" style="background-color: #4caf50;">Open Master Control</a>
                    <div class="url-display">${masterUrl}</div>
                    <button onclick="copyToClipboard('${masterUrl}')" style="background:#28a745; color:white; border:none; padding:5px 10px; border-radius:3px; margin-top:5px; cursor:pointer;">📋 Copy Link</button>
                    <div style="color: #666; font-size: 12px; margin-top: 5px;">Share this link to allow others to see all class statuses</div>
                </div>
            `;
            
            linksContainer.appendChild(masterItem);
            
            // Add individual class links
            Object.keys(classes).forEach(className => {
                const baseUrl = window.location.origin + window.location.pathname;
                const state = encodeState(classes);
                const fullUrl = `${baseUrl}?class=${encodeURIComponent(className)}&state=${state}&setup=${setupId}`;
                const qrCodeUrl = generateQRCode(fullUrl, 150);
                
                const accessItem = document.createElement('div');
                accessItem.className = 'access-item';
                
                accessItem.innerHTML = `
                    <div class="qr-container">
                        <img src="${qrCodeUrl}" alt="QR Code for ${className}" class="qr-code" width="120" height="120">
                        <div class="qr-label">Scan to Access</div>
                    </div>
                    <div class="link-info">
                        <div class="class-title">${className}</div>
                        <a href="${fullUrl}" class="access-link" target="_blank">Open Teacher Interface</a>
                        <div class="url-display">${fullUrl}</div>
                        <button onclick="copyToClipboard('${fullUrl}')" style="background:#28a745; color:white; border:none; padding:5px 10px; border-radius:3px; margin-top:5px; cursor:pointer;">📋 Copy Link</button>
                    </div>
                `;
                
                linksContainer.appendChild(accessItem);
            });

            accessLinksDiv.style.display = 'block';
        }

        function copyToClipboard(text) {
            if (navigator.clipboard) {
                navigator.clipboard.writeText(text).then(function() {
                    showSyncStatus('Link copied!', 'success');
                }).catch(function(err) {
                    fallbackCopyTextToClipboard(text);
                });
            } else {
                fallbackCopyTextToClipboard(text);
            }
        }

        function fallbackCopyTextToClipboard(text) {
            const textArea = document.createElement("textarea");
            textArea.value = text;
            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();
            try {
                document.execCommand('copy');
                showSyncStatus('Link copied!', 'success');
            } catch (err) {
                alert('Unable to copy. Please copy manually: ' + text);
            }
            document.body.removeChild(textArea);
        }

        function loadTeacherViewFromURL(stateParam) {
            const state = decodeState(stateParam);
            if (!state) {
                alert('Invalid access link. Please check your URL.');
                return;
            }

            classes = state;
            
            if (!classes[currentClass]) {
                alert('Invalid class access. Please check your link.');
                return;
            }

            showTeacherSection();
            document.getElementById('current-class').textContent = currentClass;
            renderClassesGrid();
            
            // Start polling for updates
            setInterval(pollForState, 2000);
        }

        function renderClassesGrid() {
            const grid = document.getElementById('classes-grid');
            grid.innerHTML = '';

            Object.keys(classes).forEach(className => {
                const card = document.createElement('div');
                card.className = `class-card ${classes[className]}`;
                
                const isCurrentClass = className === currentClass;
                const hasOccupiedClass = Object.values(classes).includes('occupied');
                const showWarning = !isCurrentClass && hasOccupiedClass && classes[className] === 'vacant';
                const showEmergencyWarning = isCurrentClass && hasOccupiedClass && classes[currentClass] === 'vacant';

                card.innerHTML = `
                    <div class="class-name">${className}</div>
                    <div class="status-display">
                        ${classes[className] === 'vacant' ? 'VACANT' : 'STUDENT AT TOILET'}
                    </div>
                    ${isCurrentClass ? `
                        ${showEmergencyWarning ? '<div class="emergency-warning">⚠️ ANOTHER CLASS OCCUPIED - EMERGENCY ONLY? ⚠️</div>' : ''}
                        <button class="toggle-btn ${classes[className]}" onclick="toggleClassStatus('${className}')">
                            ${classes[className] === 'vacant' ? 'Send Student to Toilet' : 'Mark Student Returned'}
                        </button>
                    ` : `
                        ${showWarning ? '<div class="warning">⚠️ Toilet Available</div>' : ''}
                        <div style="color: #6c757d; font-style: italic;">
                            ${isCurrentClass ? 'Your Class' : 'Other Class'}
                        </div>
                    `}
                `;

                grid.appendChild(card);
            });
        }

        function toggleClassStatus(className) {
            if (className !== currentClass) return;

            const newStatus = classes[className] === 'vacant' ? 'occupied' : 'vacant';
            classes[className] = newStatus;

            // Save state
            saveState();
            
            // Update URL with new state
            updateURLState();
            
            // Re-render
            renderClassesGrid();
            
            showSyncStatus('Status updated', 'syncing');
        }

        function updateURLState() {
            const state = encodeState(classes);
            const newUrl = `${window.location.pathname}?class=${encodeURIComponent(currentClass)}&state=${state}&setup=${setupId}`;
            window.history.replaceState({}, '', newUrl);
        }

        function pollForState() {
            if (!setupId) return;
            
            // Load latest state from localStorage
            if (loadState()) {
                renderClassesGrid();
            }
        }

        function showSyncStatus(message, type = 'success') {
            const statusEl = document.getElementById('sync-status');
            statusEl.textContent = message;
            statusEl.className = 'sync-status ' + (type === 'syncing' ? 'syncing' : type === 'error' ? 'error' : '');
            statusEl.style.display = 'block';
            
            setTimeout(() => {
                statusEl.style.display = 'none';
            }, 2000);
        }

        function backToSetup() {
            if (setupId) {
                window.location.href = `${window.location.pathname}?setup=${setupId}`;
            } else {
                window.location.href = window.location.pathname;
            }
        }

        // Clean up old setups (older than 24 hours)
        function cleanupOldSetups() {
            const now = Date.now();
            const maxAge = 24 * 60 * 60 * 1000; // 24 hours
            
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key && key.startsWith('toiletSystem_')) {
                    try {
                        const data = JSON.parse(localStorage.getItem(key));
                        if (data.timestamp && (now - data.timestamp) > maxAge) {
                            localStorage.removeItem(key);
                        }
                    } catch (e) {
                        // Invalid data, remove it
                        localStorage.removeItem(key);
                    }
                }
            }
        }

        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', function() {
            cleanupOldSetups();
            init();
        });
    </script>
</body>
</html>
