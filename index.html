<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Toilet Coordination System - GitHub Version</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: Arial, sans-serif;
            background-color: #f5f5f5;
            padding: 20px;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background-color: #2c3e50;
            color: white;
            padding: 20px;
            text-align: center;
        }

        .setup-section {
            padding: 30px;
        }

        .teacher-section {
            padding: 30px;
            display: none;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 10px;
            font-weight: bold;
            font-size: 16px;
        }

        input[type="text"], input[type="password"], select {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
            background-color: white;
        }

        .token-info {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            padding: 15px;
            margin-bottom: 20px;
        }

        .token-info h3 {
            margin-bottom: 10px;
            color: #495057;
        }

        .token-info ol {
            margin-left: 20px;
        }

        .token-info li {
            margin-bottom: 8px;
        }

        .token-info code {
            background-color: #e9ecef;
            padding: 2px 5px;
            border-radius: 3px;
            font-family: monospace;
        }

        .classes-selection {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .class-checkbox {
            display: flex;
            align-items: center;
            padding: 15px;
            border: 2px solid #ddd;
            border-radius: 8px;
            background-color: #f8f9fa;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .class-checkbox:hover {
            background-color: #e9ecef;
        }

        .class-checkbox.selected {
            background-color: #d4edda;
            border-color: #27ae60;
        }

        .class-checkbox input[type="checkbox"] {
            margin-right: 10px;
            transform: scale(1.2);
        }

        .class-checkbox label {
            margin: 0;
            font-weight: normal;
            cursor: pointer;
            flex: 1;
        }

        button {
            background-color: #3498db;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin: 5px;
        }

        button:hover {
            background-color: #2980b9;
        }

        .create-btn {
            background-color: #27ae60;
            padding: 15px 30px;
            font-size: 18px;
            font-weight: bold;
        }

        .create-btn:hover {
            background-color: #219a52;
        }

        .create-btn:disabled {
            background-color: #95a5a6;
            cursor: not-allowed;
        }

        .class-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .class-card {
            border: 2px solid #ddd;
            border-radius: 10px;
            padding: 20px;
            text-align: center;
            transition: all 0.3s ease;
        }

        .class-card.vacant {
            background-color: #d4edda;
            border-color: #27ae60;
        }

        .class-card.occupied {
            background-color: #f8d7da;
            border-color: #e74c3c;
        }

        .class-name {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 15px;
        }

        .status-display {
            font-size: 16px;
            margin-bottom: 15px;
            padding: 8px;
            border-radius: 5px;
            font-weight: bold;
        }

        .vacant .status-display {
            background-color: #27ae60;
            color: white;
        }

        .occupied .status-display {
            background-color: #e74c3c;
            color: white;
        }

        .toggle-btn {
            width: 100%;
            padding: 15px;
            font-size: 16px;
            font-weight: bold;
            border-radius: 8px;
            transition: all 0.3s ease;
        }

        .toggle-btn.vacant {
            background-color: #27ae60;
            color: white;
        }

        .toggle-btn.occupied {
            background-color: #e74c3c;
            color: white;
        }

        .toggle-btn:hover {
            transform: scale(1.05);
        }

        .toggle-btn:disabled {
            background-color: #95a5a6;
            cursor: not-allowed;
        }

        .warning {
            background-color: #fff3cd;
            border: 1px solid #ffeaa7;
            color: #856404;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 10px;
            font-weight: bold;
        }

        .access-links {
            margin-top: 20px;
            padding: 20px;
            background-color: #f8f9fa;
            border-radius: 8px;
        }

        .access-item {
            display: flex;
            align-items: center;
            margin: 15px 0;
            padding: 20px;
            background-color: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .qr-container {
            margin-right: 20px;
            text-align: center;
        }

        .qr-code {
            border: 2px solid #ddd;
            border-radius: 5px;
            padding: 5px;
            background-color: white;
        }

        .qr-label {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
        }

        .link-info {
            flex: 1;
        }

        .class-title {
            font-size: 18px;
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 8px;
        }

        .access-link {
            display: inline-block;
            padding: 8px 15px;
            background-color: #3498db;
            color: white;
            text-decoration: none;
            border-radius: 5px;
            font-size: 14px;
            margin-bottom: 8px;
        }

        .access-link:hover {
            background-color: #2980b9;
        }

        .url-display {
            font-family: monospace;
            font-size: 12px;
            color: #666;
            background-color: #f8f9fa;
            padding: 5px 8px;
            border-radius: 3px;
            word-break: break-all;
        }

        .print-section {
            margin-top: 20px;
            text-align: center;
        }

        .print-btn {
            background-color: #17a2b8;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
        }

        .print-btn:hover {
            background-color: #138496;
        }

        .sync-status {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 10px 15px;
            background-color: #28a745;
            color: white;
            border-radius: 5px;
            font-size: 14px;
            display: none;
            z-index: 1000;
        }

        .sync-status.syncing {
            background-color: #ffc107;
            color: #000;
        }

        .sync-status.error {
            background-color: #dc3545;
            color: white;
        }

        .error-message {
            background-color: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 10px;
        }

        .success-message {
            background-color: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 10px;
        }

        .gist-info {
            background-color: #e7f3ff;
            border: 1px solid #b8daff;
            border-radius: 5px;
            padding: 15px;
            margin-top: 20px;
        }

        .gist-info a {
            color: #004085;
            text-decoration: underline;
        }

        @media print {
            .print-btn, .back-btn, .create-btn {
                display: none;
            }
            
            .access-item {
                page-break-inside: avoid;
                margin-bottom: 30px;
            }
        }

        .back-btn {
            background-color: #6c757d;
            margin-bottom: 20px;
        }

        .back-btn:hover {
            background-color: #545b62;
        }

        .emergency-warning {
            background-color: #dc3545;
            color: white;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 10px;
            font-weight: bold;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.7; }
            100% { opacity: 1; }
        }

        .selection-summary {
            margin-top: 20px;
            padding: 15px;
            background-color: #e7f3ff;
            border-radius: 8px;
            border-left: 4px solid #3498db;
        }

        .no-selection {
            color: #6c757d;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-left: 10px;
            vertical-align: middle;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="sync-status" id="sync-status">Synced</div>
    
    <div class="container">
        <div class="header">
            <h1>Toilet Coordination System</h1>
            <p>Exam Logistics Management - GitHub Sync</p>
        </div>

        <!-- Setup Section -->
        <div id="setup-section" class="setup-section">
            <h2>Setup Classes for Exam</h2>
            
            <div id="message-container"></div>

            <div class="token-info">
                <h3>🔑 GitHub Personal Access Token Required</h3>
                <p>To use GitHub as a backend, you need a Personal Access Token:</p>
                <ol>
                    <li>Go to <a href="https://github.com/settings/tokens/new" target="_blank">GitHub Settings → Personal Access Tokens</a></li>
                    <li>Click "Generate new token (classic)"</li>
                    <li>Give it a name like "Toilet System"</li>
                    <li>Select the <code>gist</code> scope (checkbox)</li>
                    <li>Click "Generate token" and copy it</li>
                    <li>Paste it below (it will be saved locally)</li>
                </ol>
            </div>

            <div class="form-group">
                <label for="github-token">GitHub Personal Access Token:</label>
                <input type="password" id="github-token" placeholder="ghp_xxxxxxxxxxxxxxxxxxxx">
                <small style="color: #666;">This token is stored only in your browser and never sent anywhere except GitHub</small>
            </div>

            <div class="form-group">
                <label for="gist-id">Existing Gist ID (optional):</label>
                <input type="text" id="gist-id" placeholder="Leave empty to create new, or paste existing Gist ID">
                <small style="color: #666;">If you have an existing setup, paste the Gist ID here</small>
            </div>
            
            <div class="form-group">
                <label for="level-select">Select Primary Level:</label>
                <select id="level-select" onchange="updateClassNames()">
                    <option value="">-- Select Level --</option>
                    <option value="1">Primary 1</option>
                    <option value="2">Primary 2</option>
                    <option value="3">Primary 3</option>
                    <option value="4">Primary 4</option>
                    <option value="5">Primary 5</option>
                    <option value="6">Primary 6</option>
                </select>
            </div>

            <div class="form-group">
                <label>Select Classes Participating in Exam:</label>
                <div class="classes-selection" id="classes-selection">
                    <!-- Classes will be populated here -->
                </div>
            </div>

            <div id="selection-summary" class="selection-summary">
                <strong>Selected Classes:</strong>
                <div id="summary-text" class="no-selection">Please select a level first</div>
            </div>

            <button id="create-btn" class="create-btn" onclick="setupClasses()" disabled>Create System</button>

            <div id="gist-info" class="gist-info" style="display: none;">
                <h3>📋 Important: Save This Information!</h3>
                <p><strong>Gist ID:</strong> <span id="gist-id-display"></span></p>
                <p><strong>Gist URL:</strong> <a id="gist-url" href="#" target="_blank"></a></p>
                <p>Share the Gist ID with other coordinators so they can access the same system.</p>
            </div>

            <div id="access-links" class="access-links" style="display: none;">
                <h3>Access Links for Teachers</h3>
                <p>Each teacher can scan their QR code or use the link below:</p>
                <div id="links-container"></div>
                <div class="print-section">
                    <button class="print-btn" onclick="window.print()">🖨️ Print QR Codes</button>
                </div>
            </div>
        </div>

        <!-- Teacher Interface -->
        <div id="teacher-section" class="teacher-section">
            <button class="back-btn" onclick="backToSetup()">Back to Setup</button>
            
            <h2 id="teacher-title">Teacher Dashboard</h2>
            <p id="teacher-class">Managing: <span id="current-class"></span></p>

            <div id="teacher-message-container"></div>

            <div id="classes-grid" class="class-grid">
                <!-- Classes will be populated here -->
            </div>
        </div>
    </div>

    <script>
        // Global state
        let classes = {};
        let currentClass = null;
        let isTeacher = false;
        let selectedLevel = '';
        let selectedClasses = [];
        let gistId = null;
        let githubToken = null;
        let isUpdating = false;

        const classNames = ['Care', 'Charity', 'Faith', 'Grace', 'Hope', 'Joy', 'Love', 'Respect'];

        // Initialize the application
        function init() {
            // Load saved token
            githubToken = localStorage.getItem('github_token');
            if (githubToken) {
                document.getElementById('github-token').value = githubToken;
            }

            const urlParams = new URLSearchParams(window.location.search);
            const classParam = urlParams.get('class');
            const gistParam = urlParams.get('gist');
            
            if (classParam && gistParam) {
                // Teacher view
                isTeacher = true;
                currentClass = decodeURIComponent(classParam);
                gistId = gistParam;
                loadTeacherView();
            } else if (gistParam) {
                // Load existing setup
                gistId = gistParam;
                document.getElementById('gist-id').value = gistId;
                showSetupSection();
                loadExistingSetup();
            } else {
                // Fresh setup view
                showSetupSection();
                populateClassesSelection();
            }
        }

        function showSetupSection() {
            document.getElementById('setup-section').style.display = 'block';
            document.getElementById('teacher-section').style.display = 'none';
        }

        function showTeacherSection() {
            document.getElementById('setup-section').style.display = 'none';
            document.getElementById('teacher-section').style.display = 'block';
        }

        function showMessage(message, type = 'error', containerId = 'message-container') {
            const container = document.getElementById(containerId);
            const div = document.createElement('div');
            div.className = type === 'error' ? 'error-message' : 'success-message';
            div.textContent = message;
            container.innerHTML = '';
            container.appendChild(div);
            
            setTimeout(() => {
                div.remove();
            }, 5000);
        }

        function populateClassesSelection() {
            const container = document.getElementById('classes-selection');
            container.innerHTML = '';

            classNames.forEach(className => {
                const div = document.createElement('div');
                div.className = 'class-checkbox';
                div.onclick = () => toggleClassSelection(className);
                
                div.innerHTML = `
                    <input type="checkbox" id="class-${className}" onchange="toggleClassSelection('${className}')">
                    <label for="class-${className}">${className}</label>
                `;
                
                container.appendChild(div);
            });
        }

        function updateClassNames() {
            const levelSelect = document.getElementById('level-select');
            selectedLevel = levelSelect.value;
            
            // Reset selections when level changes
            selectedClasses = [];
            const checkboxes = document.querySelectorAll('.class-checkbox input[type="checkbox"]');
            checkboxes.forEach(cb => {
                cb.checked = false;
                cb.parentElement.classList.remove('selected');
            });
            
            updateSelectionSummary();
            updateCreateButton();
        }

        function toggleClassSelection(className) {
            const checkbox = document.getElementById(`class-${className}`);
            const div = checkbox.parentElement;
            
            if (checkbox.checked) {
                if (!selectedClasses.includes(className)) {
                    selectedClasses.push(className);
                }
                div.classList.add('selected');
            } else {
                selectedClasses = selectedClasses.filter(name => name !== className);
                div.classList.remove('selected');
            }
            
            updateSelectionSummary();
            updateCreateButton();
        }

        function updateSelectionSummary() {
            const summaryText = document.getElementById('summary-text');
            
            if (!selectedLevel) {
                summaryText.textContent = 'Please select a level first';
                summaryText.className = 'no-selection';
                return;
            }
            
            if (selectedClasses.length === 0) {
                summaryText.textContent = 'No classes selected';
                summaryText.className = 'no-selection';
                return;
            }
            
            const formattedClasses = selectedClasses.map(name => `${selectedLevel} ${name}`).join(', ');
            summaryText.textContent = formattedClasses;
            summaryText.className = '';
        }

        function updateCreateButton() {
            const createBtn = document.getElementById('create-btn');
            const canCreate = selectedLevel && selectedClasses.length >= 2;
            
            createBtn.disabled = !canCreate;
            
            if (canCreate) {
                createBtn.textContent = `Create System (${selectedClasses.length} classes)`;
            } else {
                createBtn.textContent = 'Create System';
            }
        }

        async function setupClasses() {
            const token = document.getElementById('github-token').value;
            
            if (!token) {
                showMessage('Please enter your GitHub Personal Access Token');
                return;
            }

            if (!selectedLevel || selectedClasses.length < 2) {
                showMessage('Please select a level and at least 2 classes');
                return;
            }

            // Save token
            githubToken = token;
            localStorage.setItem('github_token', token);

            // Initialize classes
            classes = {};
            selectedClasses.forEach(className => {
                const formattedName = `${selectedLevel} ${className}`;
                classes[formattedName] = 'vacant';
            });

            // Create or update gist
            const existingGistId = document.getElementById('gist-id').value.trim();
            if (existingGistId) {
                gistId = existingGistId;
                await updateGist();
            } else {
                await createGist();
            }
        }

        async function createGist() {
            const btn = document.getElementById('create-btn');
            btn.innerHTML = 'Creating... <span class="loading"></span>';
            btn.disabled = true;

            const data = {
                classes: classes,
                level: selectedLevel,
                created: new Date().toISOString(),
                lastUpdated: new Date().toISOString()
            };

            try {
                const response = await fetch('https://api.github.com/gists', {
                    method: 'POST',
                    headers: {
                        'Authorization': `token ${githubToken}`,
                        'Accept': 'application/vnd.github.v3+json',
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        description: `Toilet Coordination System - Level ${selectedLevel}`,
                        public: false,
                        files: {
                            'toilet-system.json': {
                                content: JSON.stringify(data, null, 2)
                            }
                        }
                    })
                });

                if (!response.ok) {
                    throw new Error(`GitHub API error: ${response.status}`);
                }

                const gist = await response.json();
                gistId = gist.id;

                // Display gist info
                document.getElementById('gist-id-display').textContent = gistId;
                document.getElementById('gist-url').href = gist.html_url;
                document.getElementById('gist-url').textContent = gist.html_url;
                document.getElementById('gist-info').style.display = 'block';

                showMessage('System created successfully!', 'success');
                generateAccessLinks();

            } catch (error) {
                showMessage(`Error creating gist: ${error.message}`);
            } finally {
                btn.innerHTML = 'Create System';
                btn.disabled = false;
            }
        }

        async function updateGist() {
            if (!gistId || !githubToken) return;

            const data = {
                classes: classes,
                level: selectedLevel,
                created: new Date().toISOString(),
                lastUpdated: new Date().toISOString()
            };

            try {
                const response = await fetch(`https://api.github.com/gists/${gistId}`, {
                    method: 'PATCH',
                    headers: {
                        'Authorization': `token ${githubToken}`,
                        'Accept': 'application/vnd.github.v3+json',
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        files: {
                            'toilet-system.json': {
                                content: JSON.stringify(data, null, 2)
                            }
                        }
                    })
                });

                if (!response.ok) {
                    throw new Error(`GitHub API error: ${response.status}`);
                }

                showSyncStatus('Updated', 'success');

            } catch (error) {
                showSyncStatus('Update failed', 'error');
                console.error('Error updating gist:', error);
            }
        }

        async function loadGistData() {
            if (!gistId) return null;

            try {
                const response = await fetch(`https://api.github.com/gists/${gistId}`, {
                    headers: {
                        'Accept': 'application/vnd.github.v3+json'
                    }
                });

                if (!response.ok) {
                    throw new Error(`GitHub API error: ${response.status}`);
                }

                const gist = await response.json();
                const content = gist.files['toilet-system.json'].content;
                return JSON.parse(content);

            } catch (error) {
                console.error('Error loading gist:', error);
                return null;
            }
        }

        async function loadExistingSetup() {
            const data = await loadGistData();
            if (data) {
                classes = data.classes;
                selectedLevel = data.level;
                
                // Update UI
                document.getElementById('level-select').value = selectedLevel;
                populateClassesSelection();
                
                // Check the appropriate classes
                Object.keys(classes).forEach(fullName => {
                    const className = fullName.replace(`${selectedLevel} `, '');
                    const checkbox = document.getElementById(`class-${className}`);
                    if (checkbox) {
                        checkbox.checked = true;
                        checkbox.parentElement.classList.add('selected');
                        if (!selectedClasses.includes(className)) {
                            selectedClasses.push(className);
                        }
                    }
                });
                
                updateSelectionSummary();
                updateCreateButton();
                generateAccessLinks();
                
                // Display gist info
                document.getElementById('gist-id-display').textContent = gistId;
                document.getElementById('gist-url').href = `https://gist.github.com/${gistId}`;
                document.getElementById('gist-url').textContent = `https://gist.github.com/${gistId}`;
                document.getElementById('gist-info').style.display = 'block';
            }
        }

        function generateQRCode(text, size = 128) {
            const qrUrl = `https://api.qrserver.com/v1/create-qr-code/?size=${size}x${size}&data=${encodeURIComponent(text)}&ecc=M`;
            return qrUrl;
        }

        function generateAccessLinks() {
            const linksContainer = document.getElementById('links-container');
            const accessLinksDiv = document.getElementById('access-links');
            
            linksContainer.innerHTML = '';
            
            // Add master control link
            const masterUrl = `${window.location.origin}${window.location.pathname}?gist=${gistId}`;
            const masterItem = document.createElement('div');
            masterItem.className = 'access-item';
            masterItem.style.backgroundColor = '#e8f5e9';
            
            masterItem.innerHTML = `
                <div class="qr-container">
                    <img src="${generateQRCode(masterUrl, 150)}" alt="QR Code for Master Control" class="qr-code" width="120" height="120">
                    <div class="qr-label">Master Control</div>
                </div>
                <div class="link-info">
                    <div class="class-title">🎛️ Master Control Panel</div>
                    <a href="${masterUrl}" class="access-link" target="_blank" style="background-color: #4caf50;">Open Master Control</a>
                    <div class="url-display">${masterUrl}</div>
                    <button onclick="copyToClipboard('${masterUrl}')" style="background:#28a745; color:white; border:none; padding:5px 10px; border-radius:3px; margin-top:5px; cursor:pointer;">📋 Copy Link</button>
                    <div style="color: #666; font-size: 12px; margin-top: 5px;">Share this link to allow others to see all class statuses</div>
                </div>
            `;
            
            linksContainer.appendChild(masterItem);
            
            // Add individual class links
            Object.keys(classes).forEach(className => {
                const baseUrl = window.location.origin + window.location.pathname;
                const fullUrl = `${baseUrl}?class=${encodeURIComponent(className)}&gist=${gistId}`;
                const qrCodeUrl = generateQRCode(fullUrl, 150);
                
                const accessItem = document.createElement('div');
                accessItem.className = 'access-item';
                
                accessItem.innerHTML = `
                    <div class="qr-container">
                        <img src="${qrCodeUrl}" alt="QR Code for ${className}" class="qr-code" width="120" height="120">
                        <div class="qr-label">Scan to Access</div>
                    </div>
